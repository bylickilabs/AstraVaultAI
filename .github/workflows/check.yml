name: ğŸ§¾ AstraVault AI â€“ Repository Integrity Check

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  repository:
    name: ğŸ§± Repository Validation & Metadata Report
    runs-on: ubuntu-latest

    steps:
      # ---------------------------------------------------------
      # 1ï¸âƒ£ Checkout Repository
      # ---------------------------------------------------------
      - name: ğŸ§± Checkout Repository
        uses: actions/checkout@v4

      # ---------------------------------------------------------
      # 2ï¸âƒ£ Set up Python
      # ---------------------------------------------------------
      - name: âš™ï¸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      # ---------------------------------------------------------
      # 3ï¸âƒ£ Set up Node.js (for markdownlint)
      # ---------------------------------------------------------
      - name: âš™ï¸ Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # ---------------------------------------------------------
      # 4ï¸âƒ£ Verify Required Files
      # ---------------------------------------------------------
      - name: ğŸ§© Verify Required Files
        run: |
          echo ">>> Checking for required project files..."
          REQUIRED_FILES=("README.md" "LICENSE" "SECURITY.md" "CONTRIBUTING.md" "requirements.txt")
          MISSING_COUNT=0
          for file in "${REQUIRED_FILES[@]}"; do
            if [ -f "$file" ]; then
              echo "âœ… $file found."
            else
              echo "âŒ Missing: $file"
              MISSING_COUNT=$((MISSING_COUNT+1))
            fi
          done
          if [ "$MISSING_COUNT" -gt 0 ]; then
            echo "âš ï¸ Missing $MISSING_COUNT critical file(s)."
          else
            echo "âœ… All essential project files are present."
          fi

      # ---------------------------------------------------------
      # 5ï¸âƒ£ Lint YAML and Markdown properly
      # ---------------------------------------------------------
      - name: ğŸ” Validate YAML & Markdown
        run: |
          echo ">>> Installing linting tools..."
          python -m pip install --upgrade pip > /dev/null
          pip install yamllint > /dev/null
          npm install -g markdownlint-cli
          echo ">>> Running YAML validation..."
          yamllint . || echo "âš ï¸ YAML warnings detected (non-critical)"
          echo ">>> Running Markdown validation..."
          markdownlint '**/*.md' || echo "âš ï¸ Markdown formatting warnings detected"

      # ---------------------------------------------------------
      # 6ï¸âƒ£ Security Scan
      # ---------------------------------------------------------
      - name: ğŸ›¡ï¸ Basic Dependency Security Scan
        run: |
          pip install safety > /dev/null
          if [ -f "requirements.txt" ]; then
            echo ">>> Scanning dependencies for vulnerabilities..."
            safety check -r requirements.txt || echo "âš ï¸ Potential security warnings found."
          else
            echo "âš ï¸ No requirements.txt found â€“ skipping dependency check."
          fi

      # ---------------------------------------------------------
      # 7ï¸âƒ£ Repository Metadata
      # ---------------------------------------------------------
      - name: ğŸ§  Collect Repository Metadata
        run: |
          echo "============================================================"
          echo "ğŸ“¦ AstraVault AI â€“ Repository Summary"
          echo "============================================================"
          echo "ğŸ§­ Repository: $GITHUB_REPOSITORY"
          echo "ğŸ”– Branch: $GITHUB_REF_NAME"
          echo "ğŸ‘¤ Triggered by: $GITHUB_ACTOR"
          echo "ğŸ•’ Commit Timestamp: $(date)"
          echo "ğŸ Python Version: $(python --version)"
          echo "------------------------------------------------------------"
          echo "ğŸ“„ Files in Repository Root:"
          ls -1 | sed 's/^/   â€¢ /'
          echo "============================================================"

      # ---------------------------------------------------------
      # 8ï¸âƒ£ Completion Summary
      # ---------------------------------------------------------
      - name: âœ… Integrity Check Completed
        run: |
          echo "============================================================"
          echo "âœ… AstraVault AI â€“ Full Repository Integrity Check Completed"
          echo "ğŸ”’ BYLICKILABS â€“ Intelligence Systems & Communications"
          echo "============================================================"
