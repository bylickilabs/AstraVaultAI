name: üßæ AstraVault AI ‚Äì Repository Integrity Check

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  repository:
    name: üß± Repository Validation & Metadata Report
    runs-on: ubuntu-latest

    steps:
      # ---------------------------------------------------------
      # 1Ô∏è‚É£ Checkout Repository
      # ---------------------------------------------------------
      - name: üß± Checkout Repository
        uses: actions/checkout@v4

      # ---------------------------------------------------------
      # 2Ô∏è‚É£ Setup Python for utility checks
      # ---------------------------------------------------------
      - name: ‚öôÔ∏è Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      # ---------------------------------------------------------
      # 3Ô∏è‚É£ Verify essential documentation files
      # ---------------------------------------------------------
      - name: üß© Verify Required Files
        run: |
          echo ">>> Checking for required project files..."
          REQUIRED_FILES=("README.md" "LICENSE" "SECURITY.md" "CONTRIBUTING.md" "requirements.txt")
          MISSING_COUNT=0
          for file in "${REQUIRED_FILES[@]}"; do
            if [ -f "$file" ]; then
              echo "‚úÖ $file found."
            else
              echo "‚ùå Missing: $file"
              MISSING_COUNT=$((MISSING_COUNT+1))
            fi
          done
          if [ "$MISSING_COUNT" -gt 0 ]; then
            echo "‚ö†Ô∏è Missing $MISSING_COUNT critical file(s)."
          else
            echo "‚úÖ All essential project files are present."
          fi

      # ---------------------------------------------------------
      # 4Ô∏è‚É£ Check for syntax and YAML validity
      # ---------------------------------------------------------
      - name: üîç Validate YAML & Markdown Syntax
        run: |
          echo ">>> Installing linting tools..."
          python -m pip install --upgrade pip > /dev/null
          pip install yamllint markdownlint-cli > /dev/null
          echo ">>> Running YAML validation..."
          yamllint . || echo "‚ö†Ô∏è YAML warnings detected (non-critical)"
          echo ">>> Running Markdown validation..."
          markdownlint . || echo "‚ö†Ô∏è Markdown formatting warnings detected"

      # ---------------------------------------------------------
      # 5Ô∏è‚É£ Gather repository metadata
      # ---------------------------------------------------------
      - name: üß† Collect Repository Metadata
        run: |
          echo "============================================================"
          echo "üì¶ AstraVault AI ‚Äì Repository Summary"
          echo "============================================================"
          echo "üß≠ Repository: $GITHUB_REPOSITORY"
          echo "üîñ Branch: $GITHUB_REF_NAME"
          echo "üë§ Triggered by: $GITHUB_ACTOR"
          echo "üïí Commit Timestamp: $(date)"
          echo "------------------------------------------------------------"
          echo "üìÑ Files in Repository Root:"
          ls -1 | sed 's/^/   ‚Ä¢ /'
          echo "------------------------------------------------------------"
          echo "üêç Python Version:"
          python --version
          echo "============================================================"

      # ---------------------------------------------------------
      # 6Ô∏è‚É£ Security Check for Dependencies
      # ---------------------------------------------------------
      - name: üõ°Ô∏è Basic Dependency Security Scan
        run: |
          echo ">>> Installing safety..."
          pip install safety > /dev/null
          if [ -f "requirements.txt" ]; then
            echo ">>> Scanning dependencies for vulnerabilities..."
            safety check -r requirements.txt || echo "‚ö†Ô∏è Potential security warnings found."
          else
            echo "‚ö†Ô∏è No requirements.txt found ‚Äì skipping dependency check."
          fi

      # ---------------------------------------------------------
      # 7Ô∏è‚É£ Completion Summary
      # ---------------------------------------------------------
      - name: ‚úÖ Integrity Check Completed
        run: |
          echo "============================================================"
          echo "‚úÖ AstraVault AI ‚Äì Full Repository Integrity Check Completed"
          echo "üîí BYLICKILABS ‚Äì Intelligence Systems & Communications"
          echo "============================================================"
