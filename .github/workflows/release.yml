name: ğŸš€ AstraVault AI â€“ Auto Release with Tag Generator

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  release:
    name: ğŸ§© Build â€¢ Tag â€¢ Publish
    runs-on: ubuntu-latest

    steps:
      # ---------------------------------------------------------
      # 1ï¸âƒ£ Checkout Repository
      # ---------------------------------------------------------
      - name: ğŸ§± Checkout Repository
        uses: actions/checkout@v4

      # ---------------------------------------------------------
      # 2ï¸âƒ£ Set up Python (optional â€“ for metadata extraction)
      # ---------------------------------------------------------
      - name: âš™ï¸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      # ---------------------------------------------------------
      # 3ï¸âƒ£ Auto-create Tag if missing (TG)
      # ---------------------------------------------------------
      - name: ğŸ·ï¸ Generate Tag if none exists
        id: autotag
        run: |
          if [[ "${GITHUB_REF}" != refs/tags/* ]]; then
            TAG="build-$(date +'%Y%m%d-%H%M')"
            echo "ğŸ”– No tag found, creating tag: $TAG"
            git config --global user.name "github-actions"
            git config --global user.email "actions@github.com"
            git tag $TAG
            git push origin $TAG
            echo "tag=$TAG" >> $GITHUB_OUTPUT
          else
            TAG="${GITHUB_REF_NAME}"
            echo "Existing tag detected: $TAG"
            echo "tag=$TAG" >> $GITHUB_OUTPUT
          fi

      # ---------------------------------------------------------
      # 4ï¸âƒ£ Create ZIP archive of the app
      # ---------------------------------------------------------
      - name: ğŸ“¦ Package AstraVault AI
        run: |
          mkdir -p dist
          zip -r dist/AstraVaultAI_${{ steps.autotag.outputs.tag }}.zip . \
              -x "*.git*" "__pycache__/*" ".github/*" "*.venv*" "*.pytest_cache*" "*.idea*" "*.vscode*"

      # ---------------------------------------------------------
      # 5ï¸âƒ£ Create / Update GitHub Release
      # ---------------------------------------------------------
      - name: ğŸš€ Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.autotag.outputs.tag }}
          name: AstraVault AI â€“ ${{ steps.autotag.outputs.tag }}
          prerelease: false
          generate_release_notes: true
          files: dist/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ---------------------------------------------------------
      # 6ï¸âƒ£ Completion Summary
      # ---------------------------------------------------------
      - name: âœ… Summary
        run: |
          echo "============================================================"
          echo "âœ… AstraVault AI â€“ Release ${TAG:-${{ steps.autotag.outputs.tag }}} Completed"
          echo "ğŸ“¦ File: dist/AstraVaultAI_${{ steps.autotag.outputs.tag }}.zip"
          echo "ğŸ”’ BYLICKILABS â€“ Intelligence Systems & Communications"
          echo "============================================================"
